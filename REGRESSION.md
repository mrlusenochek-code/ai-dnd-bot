# Regression checklist (ИИ ДНД / ai-dnd-bot)

## Цель
Проверить, что после фиксов:
- ход/кнопка "Отправить" работает без ручных костылей со "Статус"
- список игроков не становится "пустым"
- init/roll/turn/pass/pause работают без исключений
- сервер и WS не падают, логи чистые

## Предусловия (WSL)
1) Активировать venv:
   source ~/venvs/ai-dnd-bot.venv/bin/activate

2) Загрузить env:
   set -a; source .env; set +a

3) База (если нужна):
   cd ~/code/ai-dnd-bot
   docker compose ps
   alembic upgrade head

4) Запуск сервера:
   python -m uvicorn app.web.server:app --host 127.0.0.1 --port 8000

## Ручной прогон (2 игрока + админ)
Сценарий:
1) Создать игру "S" (админ).
2) Подключить 2-го игрока.
3) Оба ставят ГОТОВ.
4) Старт игры — проверка, что первый ход норм.
5) На ходе игрока:
   - поле ввода активно
   - кнопка "Отправить" активируется сразу при вводе
   - не нужно нажимать "Статус" для активации
6) Передача хода туда-сюда:
   - сообщения проходят
   - "Следующий ход: игрок #..." соответствует реальности
7) Проверить команды:
   - pass/end на своём ходу: ход завершается
   - roll/adv/dis: бросок выводится, ход НЕ заканчивается
   - pause/resume: таймер/пауза не ломают ход
   - init (админ): не падает, не путает uuid/bigint

## Ожидаемые признаки успеха
- Нет ошибок/traceback в консоли uvicorn
- Нет “пустого состояния игроков” на фронте
- Кнопка "Отправить" не требует "Статус" для оживления

## Проверка реконнекта WS и join (без спама)
Цель: убедиться, что при падении сервера фронт не долбит /api/join в ошибку,
а при поднятии сервера восстанавливается сам (без F5).

### 1) Падение сервера (Ctrl+C)
1) Открыть сессию /s/<session_id> в браузере, DevTools → Network.
2) Остановить uvicorn (Ctrl+C).
Ожидаемо:
- WebSocket закрывается/становится завершённым.
- В Network НЕ появляется пачка красных запросов POST /api/join.
- В логе клиента видно backoff: 1s → 2s → 4s → 8s → (до 10s).

### 2) Поднятие сервера (без F5)
1) Запустить uvicorn снова.
Не обновляя страницу:
Ожидаемо:
- Клиент пишет `[client] connected`.
- Появляется новый `websocket 101`.
- Делается один `POST /api/join 200` (после открытия WS).
- Состояние и игроки отображаются корректно.

### 3) Первый заход "с нуля" (без localStorage)
1) DevTools → Application → Local Storage → удалить ключи `uid` и `name` (или Clear).
2) Обновить страницу.
Ожидаемо:
- Появляется prompt имени игрока 1 раз.
- Далее `websocket 101` и один `POST /api/join 200`.

## Логи “золотого прогона” (пример)
(сюда можно вставлять последний успешный лог из консоли — коротким блоком,
чтобы сравнивать при будущих регрессиях)
